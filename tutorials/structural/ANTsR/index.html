<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANTsR &mdash; Brain Imaging and Behavior Lab</title>
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/logo.png"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Brain Imaging and Behavior Lab" />
    <meta name="title" content="ANTsR ">
    <link rel="canonical" href="http://biabl.github.io/tutorials/structural/ANTsR/">
     
           
    <meta property="og:title" content="ANTsR "/>
    <meta property="og:url" content="http://biabl.github.io/tutorials/structural/ANTsR/"/>
    
    
    <meta property="og:site_name" content="Brain Imaging and Behavior Lab">     
</head>
<body>
    <section class="site-nav">
        <header>
            <nav id="navigation">
                <a class="brand" href="/"><img alt="Inc" src="/images/logo.png"></a> 
                <a class="home" href="/">Blog</a>
                <a class="home" href="/tags/">Tags</a>
				<li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
                    <ul class="dropdown-menu multi-level">
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">General Topics</a>
                            <ul class="dropdown-menu">
                                <li><a href="/tutorials/general/unix-cheat-sheet/">Unix Cheat Sheet</a></li>
                				<li><a href="/tutorials/general/introduction-to-fulton-supercomputer-lab/">Introduction to Fulton Supercomputer</a></li>
                				<li><a href="/tutorials/general/submitting_jobs/">Submitting Batch Jobs on Supercomputer</a></li>
                				<li><a href="/tutorials/general/R/">Learn R</a></li>
                				<li><a href="/tutorials/general/install-freesurfer/">How to Install Freesurfer on Supercomputer</a></li>
                            </ul>
                        </li>
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Structural Imaging Topics</a>
                            <ul class="dropdown-menu">
                                <li><a href="/tutorials/structural/preprocessing_T1_weighted_images/">Preprocessing T1 Weighted Images</a></li>
                				<li><a href="/tutorials/structural/convert-to-nifti/">Other Ways to Convert to NIfTI</a></li>
                				<li><a href="/tutorials/structural/normalization/">Normalization</a></li>
                				<li><a href="/tutorials/structural/cortical_thickness/">Tissue Segmentation and Cortical Thickness</a></li>
                				<li><a href="/tutorials/structural/morphometry/">Various Morphometry Analyses</a></li>
                				<li><a href="/tutorials/structural/ANTsR/">ANTsR</a></li>
                				<li><a href="/tutorials/structural/group_average/">Group Average Overlays with ANTsR</a></li>
                				<li><a href="/tutorials/structural/roi/">ROI Analysis with DKT</a></li>
                            </ul>
                        </li>
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Diffusion Imaging Topics</a>
                            <ul class="dropdown-menu">
                                <li><a href="/tutorials/diffusion/preprocessing_diffusion_weighted_images/">Preprocessing Diffusion Weighted Images</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Projects<b class="caret"></b></a>
                    <ul class="dropdown-menu multi-level">
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">MIOS</a>
                            <ul class="dropdown-menu">
                                <li><a href="/projects/MIOS/corpus-callosum/">Corpus Callosum</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </nav>
        </header>
    </section>
    
<article>

    <div class="container">
        <header>
        	
            <div class="meta">
                By <address><a rel="author" href="" title="Naomi J. Goodrich-Hunsaker" target="_blank">Naomi J. Goodrich-Hunsaker</a></address> &mdash;
                <time pubdate datetime="2015-09-December" title="December 09, 2015">December 09, 2015</time>
            </div>
            <h1 class="title">ANTsR</h1>
            
        </header>

        <section>
            <h2 id="objectives">Objectives</h2>

<p>After you complete this section, you should be able to:</p>

<ol>
  <li>Install ANTsR on the supercomputer</li>
  <li>Complete a simple linear regression analysis</li>
  <li>Visualize results</li>
</ol>

<p>Note that everything in “&lt;&gt;” is to be replaced. For example, &lt;fileName&gt; –&gt; iLovePeanuts.txt</p>

<h2 id="install-antsr">Install ANTsR</h2>

<p>R has already been installed on the supercomputer. Log into the supercomputer:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">ssh &lt;username&gt;@ssh.fsl.byu.edu</code></pre></div>

<p>Load the environmental variables so that R will run on the supercomputer:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">module load cmake/2.8.10
module load r/3.2.1</code></pre></div>

<p>R relies on packages to run functions. There are currently 7462 packages available. Since any normal user probably only uses &lt;10% of packages, you have to install the packages you will want to use. You need to create directory in your home directory to keep these packages. Once you’ve created this directory, you also need to set your R environment to know where to look for this directory:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir ~/R
<span class="nb">echo</span> <span class="s1">&#39;R_LIBS_USER=&quot;~/R&quot;&#39;</span> &gt;  <span class="nv">$HOME</span>/.Renviron</code></pre></div>

<p>The first package needs to be downloaded directly from source, all the other packages can be installed from within R:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/R
wget https://github.com/Rexamine/stringi/archive/master.zip
unzip master.zip
R CMD INSTALL stringi-master</code></pre></div>

<p>Launch R:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">R</code></pre></div>

<p>Let’s install a couple of packages and their dependencies:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kp">options</span><span class="p">(</span>download.file.method <span class="o">=</span> <span class="s">&quot;wget&quot;</span><span class="p">)</span>
pkgnames <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;Rcpp&quot;</span><span class="p">,</span> <span class="s">&quot;tools&quot;</span><span class="p">,</span> <span class="s">&quot;methods&quot;</span><span class="p">,</span> <span class="s">&quot;drat&quot;</span><span class="p">)</span>
install.packages<span class="p">(</span>pkgnames<span class="p">,</span> dependencies <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> repos<span class="o">=</span><span class="s">&quot;http://cran.rstudio.com/&quot;</span><span class="p">)</span></code></pre></div>

<p>The following packages also need to be installed, but without dependencies:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">pkgnames <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;stringr&quot;</span><span class="p">,</span> <span class="s">&quot;evaluate&quot;</span><span class="p">,</span> <span class="s">&quot;knitr&quot;</span><span class="p">,</span> <span class="s">&quot;magrittr&quot;</span><span class="p">)</span>
install.packages<span class="p">(</span>pkgnames<span class="p">,</span> dependencies <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> repos<span class="o">=</span><span class="s">&quot;http://cran.rstudio.com/&quot;</span><span class="p">)</span></code></pre></div>

<p>Finally, you are ready to install ANTsR:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">drat<span class="o">::</span>addRepo<span class="p">(</span><span class="s">&quot;ANTs-R&quot;</span><span class="p">)</span>
install.packages<span class="p">(</span><span class="s">&quot;ANTsR&quot;</span><span class="p">)</span></code></pre></div>

<p>Now anytime you want to run R, all you have to do is:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">module load r/3.2.1
R</code></pre></div>

<h2 id="simple-linear-regression-analysis">Simple Linear Regression Analysis</h2>

<p>Let’s load our packages. Remember, you’ve already installed all the packages (<code>install.packages</code>) now all you have to do is load the packages you want to use (<code>library</code>):</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>ANTsR<span class="p">)</span></code></pre></div>

<p>Set path to directory containing your data:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kp">setwd</span><span class="p">(</span><span class="s">&quot;/path/to/data/&quot;</span><span class="p">)</span></code></pre></div>

<h3 id="import-data">Import Data</h3>

<p>Import files and smooth - The following code creates a list of files in your working directory (<em>files</em>). Any empty list is created for when the images are smoothed they are added to the empty list (<em>ilist</em>). For each image in the <em>files</em> list, the are imported and smoothed and then added to the <em>ilist</em> list.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">files<span class="o">&lt;-</span><span class="kp">list.files</span><span class="p">()</span>
ilist<span class="o">&lt;-</span><span class="kt">list</span><span class="p">()</span>
<span class="kr">for</span> <span class="p">(</span> i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span><span class="kp">length</span><span class="p">(</span>files<span class="p">)</span> <span class="p">)</span>
<span class="p">{</span>
  img<span class="o">&lt;-</span>antsImageRead<span class="p">(</span>files<span class="p">[</span>i<span class="p">])</span>
  img<span class="o">&lt;-</span>smoothImage<span class="p">(</span>img<span class="p">,</span><span class="m">1.5</span><span class="p">)</span>
  ilist<span class="p">[</span>i<span class="p">]</span><span class="o">&lt;-</span>img
<span class="p">}</span></code></pre></div>

<p>Convert to matrices - A simple mask is created to know what is and is not data to analyze. You don’t want to analyze nonbrain data. The values are extracted from each voxel to form a 3D matrix.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">mask<span class="o">&lt;-</span>getMask<span class="p">(</span>antsImageRead<span class="p">(</span>files<span class="p">[</span><span class="m">1</span><span class="p">]))</span>
mat<span class="o">&lt;-</span>imageListToMatrix<span class="p">(</span>ilist<span class="p">,</span> mask<span class="p">)</span></code></pre></div>

<h3 id="merge-with-demographic-data">Merge with Demographic Data</h3>

<p>Demographic data can be anything from group ID, age, and gender. Data can also include neuropsych outcomes etc. To make life easy, your demographics file sound have the same study IDs as your MRI files and also be in alphanumeric order.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">mydata<span class="o">&lt;-</span>read.table<span class="p">(</span><span class="s">&quot;/path/to/directory/demographics.csv&quot;</span><span class="p">,</span> header<span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;,&quot;</span><span class="p">)</span></code></pre></div>

<p>Subset data to demographics and desired variable column:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">vardata<span class="o">&lt;-</span>mydata<span class="p">[</span><span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">)]</span>
var1<span class="o">&lt;-</span>vardata<span class="p">[,</span><span class="m">2</span><span class="p">]</span></code></pre></div>

<p>Get rid of any missing data. R does <strong>NOT</strong> like missing data and will often not run if there’s missing data.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">vardata<span class="o">&lt;-</span>na.omit<span class="p">(</span>vardata<span class="p">)</span></code></pre></div>

<p>Take the subject ID information from the files. Namely your files should be labeled as subject ID (again to make life easier). Since the names in the <em>files</em> list contain not only the subject ID but also the file type (.nii.gz), we want just the subject ID which is 10 characters long. We can then merge the <em>study id</em> list with the demographics <em>vardata</em> and make sure we just have demographics data for the participants with images.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">studyid<span class="o">=</span><span class="kp">substr</span><span class="p">(</span>files<span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">11</span><span class="p">)</span>
studyid<span class="o">=</span><span class="kt">data.frame</span><span class="p">(</span>studyid<span class="p">)</span>
vardata<span class="o">=</span><span class="kp">merge</span><span class="p">(</span>vardata<span class="p">,</span>studyid<span class="p">,</span>all.y<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
varlist<span class="o">&lt;-</span><span class="kp">rownames</span><span class="p">(</span>vardata<span class="p">)</span>
varlist<span class="o">&lt;-</span><span class="kp">as.numeric</span><span class="p">(</span>varlist<span class="p">)</span>
varlist<span class="o">&lt;-</span><span class="kt">list</span><span class="p">(</span>varlist<span class="p">)</span>
<span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> varlist<span class="p">){</span>
varmat<span class="o">&lt;-</span><span class="kp">subset</span><span class="p">(</span>mat<span class="p">[</span>i<span class="p">,])</span>
<span class="p">}</span></code></pre></div>

<h3 id="run-analysis">Run analysis</h3>

<div class="highlight"><pre><code class="language-r" data-lang="r">voxels<span class="o">&lt;-</span><span class="kp">ncol</span><span class="p">(</span>varmat<span class="p">)</span>
regpval<span class="o">&lt;-</span><span class="kt">matrix</span><span class="p">(</span>nrow<span class="o">=</span><span class="m">1</span><span class="p">,</span>ncol<span class="o">=</span>voxels<span class="p">)</span>
regtstat<span class="o">&lt;-</span><span class="kt">matrix</span><span class="p">(</span>nrow<span class="o">=</span><span class="m">1</span><span class="p">,</span>ncol<span class="o">=</span>voxels<span class="p">)</span>
<span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span>voxels<span class="p">){</span>
vox<span class="o">&lt;-</span>varmat<span class="p">[,</span>i<span class="p">]</span>
regfit<span class="o">&lt;-</span>lm<span class="p">(</span>vox<span class="o">~</span>var1<span class="p">)</span>
regsum<span class="o">&lt;-</span><span class="kp">summary</span><span class="p">(</span>regfit<span class="p">)</span>
regpval<span class="p">[,</span>i<span class="p">]</span><span class="o">&lt;-</span>regsum<span class="o">$</span>coefficients<span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">4</span><span class="p">]</span>
regtstat<span class="p">[,</span>i<span class="p">]</span><span class="o">&lt;-</span>regsum<span class="o">$</span>coefficients<span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">]</span>
<span class="p">}</span></code></pre></div>

<h3 id="convert-to-statistical-images">Convert to statistical images</h3>

<p>The data is in the form of a 3D matrix and needs to be converted into a visual NIfTI image.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">i.regpval<span class="o">&lt;-</span>makeImage<span class="p">(</span>mask<span class="p">,</span>regpval<span class="p">)</span>
antsImageWrite<span class="p">(</span>i.regpval<span class="p">,</span>file<span class="o">=</span><span class="s">&quot;/path/to/output/directory/regpval.nii.gz&quot;</span><span class="p">)</span>
i.regtstat<span class="o">&lt;-</span>makeImage<span class="p">(</span>mask<span class="p">,</span>regtstat<span class="p">)</span>
antsImageWrite<span class="p">(</span>i.regtstat<span class="p">,</span>file<span class="o">=</span><span class="s">&quot;/path/to/output/directory/regtstat.nii.gz&quot;</span><span class="p">)</span></code></pre></div>

<h2 id="visualize-results">Visualize Results</h2>

<p>Data can be download from the supercomputer to a local computer. Using your template image, you can add the <em>regtstat</em> file as an overlay to see results.</p>

<p><img src="images/tstat.png" alt="" /></p>

<h3 id="additional-classroom-materials">Additional Classroom Materials</h3>

<ul>
  <li><a href="assignment-part1">Assignment Part 1</a></li>
  <li><a href="assignment-part2">Assignment Part 2</a></li>
  <li><a href="assignment-part3">Assignment Part 3</a></li>
</ul>

            
        </section>

        <footer>
            <address>
               <img src="/images/naomi.jpg">
                <p>Written by <strong><a rel="author" href="https://twitter.com/" title="" target="_blank">Naomi J. Goodrich-Hunsaker</a></strong><br>
                <span class="muted">Website Manager</span>
                </p>
            </address>

        </footer>

        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'biabl'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>

    <footer class="site-footer">
        <div class="container">
            &copy; 2015
            <nav>
                <a href="http://biabl.github.io">Brain Imaging and Behavior Lab</a>
            </nav>
            <nav class="social">
                 
                 
                <a href="/feed.xml" title="RSS Feed"><i class="icon icon-rss black"></i></a>
            </nav>
        </div>
    </footer>
    
      <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js" defer></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" defer></script>
  <script src="dist/js/bootstrap-submenu.min.js" defer></script>
  <style type="text/css">
<script src="/assets/main.js"></script>







</body>
</html>