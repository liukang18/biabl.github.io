<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Normalization &mdash; Brain Imaging and Behavior Lab</title>
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/logo.png"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Brain Imaging and Behavior Lab" />
    <meta name="title" content="Normalization ">
    <link rel="canonical" href="http://biabl.github.io/tutorials/structural/normalization/">
     
           
    <meta property="og:title" content="Normalization "/>
    <meta property="og:url" content="http://biabl.github.io/tutorials/structural/normalization/"/>
    
    
    <meta property="og:site_name" content="Brain Imaging and Behavior Lab">     
</head>
<body>
    <section class="site-nav">
        <header>
            <nav id="navigation">
                <a class="brand" href="/"><img alt="Inc" src="/images/logo.png"></a> 
                <a class="home" href="/">Blog</a>
                <a class="home" href="/tags/">Tags</a>
				<li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
                    <ul class="dropdown-menu multi-level">
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">General Topics</a>
                            <ul class="dropdown-menu">
                                <li><a href="/tutorials/general/unix-cheat-sheet/">Unix Cheat Sheet</a></li>
                				<li><a href="/tutorials/general/introduction-to-fulton-supercomputer-lab/">Introduction to Fulton Supercomputer</a></li>
                				<li><a href="/tutorials/general/submitting_jobs/">Submitting Batch Jobs on Supercomputer</a></li>
                				<li><a href="/tutorials/general/R/">Learn R</a></li>
                				<li><a href="/tutorials/general/install-freesurfer/">How to Install Freesurfer on Supercomputer</a></li>
                            </ul>
                        </li>
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Structural Imaging Topics</a>
                            <ul class="dropdown-menu">
                                <li><a href="/tutorials/structural/preprocessing_T1_weighted_images/">Preprocessing T1 Weighted Images</a></li>
                				<li><a href="/tutorials/structural/convert-to-nifti/">Other Ways to Convert to NIfTI</a></li>
                				<li><a href="/tutorials/structural/normalization/">Normalization</a></li>
                				<li><a href="/tutorials/structural/cortical_thickness/">Tissue Segmentation and Cortical Thickness</a></li>
                				<li><a href="/tutorials/structural/morphometry/">Various Morphometry Analyses</a></li>
                				<li><a href="/tutorials/structural/ANTsR/">ANTsR</a></li>
                				<li><a href="/tutorials/structural/group_average/">Group Average Overlays with ANTsR</a></li>
                				<li><a href="/tutorials/structural/roi/">ROI Analysis with DKT</a></li>
                            </ul>
                        </li>
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Diffusion Imaging Topics</a>
                            <ul class="dropdown-menu">
                                <li><a href="/tutorials/diffusion/preprocessing_diffusion_weighted_images/">Preprocessing Diffusion Weighted Images</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Projects<b class="caret"></b></a>
                    <ul class="dropdown-menu multi-level">
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">MIOS</a>
                            <ul class="dropdown-menu">
                                <li><a href="/projects/MIOS/corpus-callosum/">Corpus Callosum</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </nav>
        </header>
    </section>
    
<article>

    <div class="container">
        <header>
        	
            <div class="meta">
                By <address><a rel="author" href="" title="Naomi J. Goodrich-Hunsaker" target="_blank">Naomi J. Goodrich-Hunsaker</a></address> &mdash;
                <time pubdate datetime="2015-09-December" title="December 09, 2015">December 09, 2015</time>
            </div>
            <h1 class="title">Normalization</h1>
            
        </header>

        <section>
            <h2 id="objectives">Objectives</h2>

<p>After you complete this section, you should be able to:</p>

<ol>
  <li>Define rigid, affine, and diffeomorphic based morphometry</li>
  <li>Understand when you do and do not need to include brain volume as a covariate</li>
  <li>Define fixed and moving image as it pertains to image registration</li>
  <li>Run rigid, affine, and diffeomorphic registration using ANTs</li>
</ol>

<p>Note that everything in “&lt; &gt;” is to be replaced. For example, &lt;fileName&gt; –&gt; iLovePeanuts.txt</p>

<h2 id="types-of-morphometry">Types of Morphometry</h2>

<h3 id="rigid-body">Rigid Body</h3>

<p>For a rigid body, you can:</p>

<h4 id="move">Move</h4>

<figure>
	<img alt="" src="images/move.jpg" />
	
</figure>

<h4 id="rotate">Rotate</h4>

<figure>
	<img alt="" src="images/rotate.jpg" />
	
</figure>

<h4 id="mirror">Mirror</h4>

<figure>
	<img alt="" src="images/mirror.jpg" />
	
</figure>

<p>Rigid-body transformations involve displacements and / or rotations of the whole object. An object can therefore move: up or down; left or right ; front or back; rotate; and reflect across an axis (2D) or plane (3D). Whether you are dealing with a 2 or 3 dimensional object, the whole object must move. In other words, if you want to move one point up and to the left, then you must move ALL points within the object that same amount up and to the left.</p>

<p>Volume (size of the brain) is not affected by rigid body transformations.</p>

<h3 id="affine">Affine</h3>

<p>For an affine transformation, you can:</p>

<h4 id="scale">Scale</h4>

<figure>
	<img alt="" src="images/scale.jpg" />
	
</figure>

<h4 id="shear">Shear</h4>

<figure>
	<img alt="" src="images/shear.jpg" />
	
</figure>

<p>Affine again effects the whole object as a rigid body and adds two additional transformations: scale and shear. Scaling means the object can increase or decrease in size. However, the ratio of each plane does not have to remain the same. You can increase the size along one plane only or all planes but differently. Shearing means you displace one plane, while leaving the rest of the planes fixed.</p>

<p>Affine transformations preserve proportions, it does not preserve volume, because it can change angles and lengths. Therefore, affine transformations automatically account of brain size differences, since affine transformations will make all brains the same size.</p>

<h3 id="diffeomorphism">Diffeomorphism</h3>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/2/26/Mug_and_Torus_morph.gif" alt="" /></p>

<p>Based on the mathematical field of topology, the simplest definition is that through <em>smooth, continuous</em> deformation, one brain can be warped to look like another brain. Using diffeomorphic morphometry, this smooth, continuous deformation, preserves the topology of the brain (i.e., sulci and gyri). The solution (how and where each voxel needs to be moved) is bidirectional. In other words, the solution, warp field, not only solves the problem of how to make the participant image look like the template, but to make the solution more robust, also finds how the make the template look like the participant image. Because of this smooth, continuous warping, the errors inherent to nonlinear warping are reduced.</p>

<h2 id="ants-nonlinear-registration">ANTs Nonlinear Registration</h2>

<p><img src="images/comparing.jpg" alt="" /></p>

<p>For reference, typically the <em>fixed</em> image is a <em>template</em> and the <em>moving</em> image is <em>each participant</em>.</p>

<p>ANTs has two shell scripts for running image registration: antsRegistrationSyn.sh and antsRegistrationSynQuick.sh. Both of these commands are simplified shell scripts of the actual command <code>antsRegistration</code>. You can view the code in these scripts by running either:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">cat /usr/local/antsbin/bin/antsRegistrationSyn.sh
cat /usr/local/antsbin/bin/antsRegistrationSynQuick.sh</code></pre></div>

<p>One of the differences between the two commands is the number of iterations in the last iteration step. For antsRegistrationSynQuick.sh there are 0 iterations and for antsRegistrationSyn.sh there are 100 iterations. The other difference is the metric used for registration. For antsRegistrationSynQuick.sh, the registration metric is based on mutual information (great for multimodal images). For antsRegistrationSyn.sh, the registration metric is based on cross correlation (great for T1 weighted image registration). The options for each is the same, but for this class, we will just show the quick version.</p>

<h3 id="rigid">Rigid</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">antsRegistrationSynQuick.sh <span class="se">\ </span>
-d <span class="m">3</span> <span class="se">\</span>
-f &lt;fixedImage&gt;.nii.gz <span class="se">\</span>
-m &lt;movingImage&gt;.nii.gz <span class="se">\</span>
-o &lt;outputPrefix&gt;
-t r</code></pre></div>

<p>Here the participant image (moving) was rigidly aligned to the template (fixed). As you can see the participant brain was moved to the same location within the field of view box. The size of the participant image was not altered.</p>

<p><img src="images/rigid.jpeg" alt="" /></p>

<p>Here the inverse warp occurred (a unique feature of ANTs). The template (fixed) image was rigidly moved to the same space as the participant image (moving). The warp matrix was just reversed even though the original mapping was the participant image (moving image) to the template image (fixed image).</p>

<p><img src="images/rigidInverse.jpeg" alt="" /></p>

<h3 id="affine-1">Affine</h3>

<p>For this transformation, rigid transformation is done first, then affine transformation.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">antsRegistrationSynQuick.sh <span class="se">\ </span>
-d <span class="m">3</span> <span class="se">\</span>
-f &lt;fixedImage&gt;.nii.gz <span class="se">\</span>
-m &lt;movingImage&gt;.nii.gz <span class="se">\</span>
-o &lt;outputPrefix&gt;
-t a</code></pre></div>

<p>Here the participant image (moving) was affine aligned to the template (fixed). The participant image was scaled to template. In this case the small participant image was enlarged to fit in the template space.</p>

<p><img src="images/affine.jpeg" alt="" /></p>

<p>The opposite is true when the inverse warp matrix is applied. The template image shrinks in size to match the participant image.</p>

<p><img src="images/affineInverse.jpeg" alt="" /></p>

<h3 id="diffeomorphic">Diffeomorphic</h3>

<p>For this transformation, rigid transformation is done first, then affine transformation, and finally diffeomorphic. You always want to do an affine transformation before a diffeomorphic transformation, because you want to eliminate brain size as a covariate. Therefore, any group analyses that result in differences is due to actual differences in regional volume and not due to general brain volume differences.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">antsRegistrationSynQuick.sh <span class="se">\ </span>
-d <span class="m">3</span> <span class="se">\</span>
-f &lt;fixedImage&gt;.nii.gz <span class="se">\</span>
-m &lt;movingImage&gt;.nii.gz <span class="se">\</span>
-o &lt;outputPrefix&gt;
-t s</code></pre></div>

<p>Here the participant image (moving) was warped to match the template (fixed). As far as possible, the participant image was nonlinearly morphed to look like the template. The participant in this case has some major brain damage and therefore the mapping isn’t perfect.</p>

<p><img src="images/diffeomorphic.jpeg" alt="" /></p>

<p>More drastic is taking the inverse warp and seeing how well the template can be made to look like the participant image. Particularly take note as how well or not so well the hippocampus and ventricles mapped! This was an extremely difficult case to diffeomoprhically warp because of the extensive brain damage.</p>

<p><img src="images/diffeomorphicInverse.jpeg" alt="" /></p>

<h2 id="warp-field">Warp Field</h2>

<p>The output from a rigid or affine transformation is a simple text file (not really useful). However, the output from the nonlinear deformation is a warp field. It is a 3D map that contains the data for each voxel’s displacement. In other words, the warp matrix contains the directions for where each voxel in the participant image (moving image) needs to move in order to look like the template (fixed image). Because the ANTs nonlinear warp is bidirectional, ANTs also outputs the inverse warp field. This field contains opposite information; it contains the directions for where each voxel in the template (fixed image) needs to move in order to look like the participant image (moving image). These warp field files are not useful beyond providing displacement information, but more on that later.</p>

<p><img src="images/warp.png" alt="" />
<img src="images/inversewarp.png" alt="" /></p>

<h3 id="additional-classroom-materials">Additional Classroom Materials</h3>

<ul>
  <li><a href="presentation">Lecture</a></li>
  <li><a href="assignment">Assignment</a></li>
</ul>

            
        </section>

        <footer>
            <address>
               <img src="/images/naomi.jpg">
                <p>Written by <strong><a rel="author" href="https://twitter.com/" title="" target="_blank">Naomi J. Goodrich-Hunsaker</a></strong><br>
                <span class="muted">Website Manager</span>
                </p>
            </address>

        </footer>

        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'biabl'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>

    <footer class="site-footer">
        <div class="container">
            &copy; 2015
            <nav>
                <a href="http://biabl.github.io">Brain Imaging and Behavior Lab</a>
            </nav>
            <nav class="social">
                 
                 
                <a href="/feed.xml" title="RSS Feed"><i class="icon icon-rss black"></i></a>
            </nav>
        </div>
    </footer>
    
      <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js" defer></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" defer></script>
  <script src="dist/js/bootstrap-submenu.min.js" defer></script>
  <style type="text/css">
<script src="/assets/main.js"></script>







</body>
</html>