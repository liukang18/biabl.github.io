
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Preprocessing T1 Weighted Images</title>
    
    <meta name="author" content="Naomi Goodrich-Hunsaker, Ph.D.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/assets/themes/bootstrap/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/themes/bootstrap/css/pygments.css">
  
    <!--[if lt IE 9]>
      <script src="/assets/themes/bootstrap/resources/respond/Respond.min.js"></script>
    <![endif]-->

    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Brain Imaging and Behavior Lab</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
          <li><a href="/tutorials">Tutorials </a></li>
          <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Projects <span class="caret"></span></a>
          <ul class="dropdown-menu">
          	<li class="dropdown-header">SOBIK</li>
            <li><a href="/projects/SOBIK/template/">Template</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">MIOS</li>
            <li><a href="/projects/MIOS/corpus-callosum">Corpus Callosum</a></li>
          </ul>
        </li>
        <li>  </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
    <div class="container">
      

<div class="page-header">
  <h1>Preprocessing T1 Weighted Images </h1>
</div>

    <div class="row">
        <div class="col-sm-3">
            <div class="sidebar-nav">
                <div class="navbar navbar-default" role="navigation">
                    <div class="navbar-header">
                        <button class="navbar-toggle" data-target=".sidebar-navbar-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <span class="visible-xs navbar-brand">Sidebar menu</span>
                    </div>
                    <div class="navbar-collapse collapse sidebar-navbar-collapse">
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a class="dropdown-toggle" data-toggle="dropdown" href="#">General Topics <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                   <li><a href="/tutorials/general/unix-cheat-sheet/">Unix Cheat Sheet</a></li>
                                    <li><a href="/tutorials/general/introduction-to-fulton-supercomputer-lab/">Introduction to Fulton Supercomputer</a></li>
                                    <li><a href="/tutorials/general/submitting-jobs/">Submitting Batch Jobs on Supercomputer</a></li>
                                    <li><a href="/tutorials/general/R/">Learn R</a></li>
                                    <li><a href="/tutorials/general/install-freesurfer/">How to Install Freesurfer on Supercomputer</a></li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a class="dropdown-toggle" data-toggle="dropdown" href="#">Structural Imaging <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li><a href="/tutorials/structural/preprocessing_T1_weighted_images/">Preprocessing T1 Weighted Images</a></li>
                                    <li><a href="/tutorials/structural/convert-to-nifti/">Other Ways to Convert to NIfTI</a></li>
                                    <li><a href="/tutorials/structural/normalization/">Normalization</a></li>
                                    <li><a href="/tutorials/structural/cortical_thickness/">Tissue Segmentation and Cortical Thickness</a></li>
                                    <li><a href="/tutorials/structural/morphometry/">Various Morphometry Analyses</a></li>
                                    <li><a href="/tutorials/structural/ANTsR/">ANTsR</a></li>
                                    <li><a href="/tutorials/structural/group_average/">Group Average Overlays with ANTsR</a></li>
                                    <li><a href="/tutorials/structural/roi/">ROI Analysis with DKT</a></li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a class="dropdown-toggle" data-toggle="dropdown" href="#">Diffusion Imaging <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li><a href="/tutorials/diffusion/preprocessing_diffusion_weighted_images/">Preprocessing Diffusion Weighted Images</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div><!--/.nav-collapse -->
                </div>
            </div>
        </div>
        <div class="col-sm-9">
 <p>After you complete this section, you should be able to:</p>

<ol>
  <li>Convert a DICOM directory into a NIfTI image</li>
  <li>Check that your MR image contains no patient information</li>
  <li>Orientate MR images into standard orientation</li>
  <li>Align images along the horizontal anterior commissure and posterior commissure plane, and why</li>
  <li>Know what a bias field is and how to fix it</li>
  <li>Know when and how to resample the size of voxels in an MR image</li>
</ol>

<p>Note that everything in “&lt;&gt;” is to be replaced. For example, &lt;fileName&gt; –&gt; iLovePeanuts.txt</p>

<h2 id="convert-dicom-to-nifti">Convert DICOM to NIfTI</h2>

<p>Most imaging programs and pipelines do not actually use DICOMs, but some other “standardized” image format. Similar to how pictures can be in various formats like jpeg, tiff, png, etc. MR images can come in different formats as well. The most common format is the NIfTI format (.nii) or the zipped NIfTI format (.nii.gz). Most programs will be able to use the NIfTI and the zipped NIfTI interchangeably, but there are still a few programs that prefer one over the other. <strong>For the first part of our pipeline, we will use the NIfTI format, but eventually we will move to using the zipped NIfTI format exclusively for the rest of the pipeline.</strong></p>

<p>First let’s create a T1 directory within our participant directory. Often times you will be working with multiple scan modalities and you will want to put those in separate directories (e.g., DTI, fMRI, T2w, etc.).</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">subjDir</span><span class="o">=</span>&lt;/path/to/subject/directory&gt;
mkdir <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/t1</code></pre></figure>

<p>Time to convert the DICOMs to NIfTI format. The simplest way to run the code is:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">dcm2nii <span class="se">\</span>
-o <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/t1 <span class="se">\</span>
<span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/DICOMs/*</code></pre></figure>

<h3 id="anonymize">Anonymize</h3>

<p>However, there are many other options you probably want to take into consideration. First of all, it is never a bad habit to get into to automatically anonymize the data. DICOMs will contain patient name, date of birth, weight, location of scan, date and time of scan, etc.</p>

<p><img class="img-responsive" alt="" src="images/anonymize.png" /></p>

<p>The option <code>-a y</code> will anonymize participant information located in the DICOM files.</p>

<h3 id="crop-and-reorient">Crop and Reorient</h3>

<p>There are three critical issues with brain orientation: (1) moving the brain to “standard orientation”, (2) field of view size, and (3) alignment. The “standard orientation” is based off of the MNI template. The x coordinates go from negative to positive from left to right. In other words, the left side of the brain is denoted by negative x coordinates and the right side of the brain is denoted by positive x coordinates. The y coordinates increase from posterior to anterior. The z coordinates increase from inferior to superior. However, sometimes scans are acquired sagittally and thus the “standard orientation” is off. In other words, sagittal will be labeled as “coronal” and the rest of the brain orientation is thrown off. In the example below, the coronal view is rotated. Not all imaging programs will correctly read this rotation (e.g., ANALYZE), therefore it is important to make sure the brain is put into “standard orientation”.</p>

<div class="row">
    <div class="col-xs-6">
		<img class="img-responsive" alt="" src="images/t1.png" />
	</div>
	<div class="col-xs-6">
		<img class="img-responsive" alt="" src="images/t1-reorientated.png" />
	</div>
</div>

<p>Second, each scan sequence has a set field of view (FOV) box. If studying children particularly, sometimes that FOV box is barely enough to acquire the brain, cutting parts of the skull out of the image. Other times the FOV box is so small that you are getting neck and spine in the image. When you begin any imaging analysis you want to make sure all the brains are orientated correctly and that you remove as much of the excess space and non-brain aspects of the image.</p>

<p><img class="img-responsive" alt="" src="images/t1-cropped-reorientated.png" /></p>

<p>The <code>dcm2nii</code> program will reorient and crop the images using the <code>-x</code> option. The following code below will anonymize the image <code>-a</code>, just provide a NIfTI file and <strong>NOT</strong> a zipped file <code>-g</code>, and crop / reorient the image <code>-x</code>.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">dcm2nii <span class="se">\</span>
-a y <span class="se">\</span>
-g n <span class="se">\</span>
-x y <span class="se">\</span>
-o <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/t1 <span class="se">\</span>
<span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/DICOMs/*</code></pre></figure>

<h3 id="rename">Rename</h3>

<p>Before we get to the issue of alignment, look closely, the file names that <code>dcm2nii</code> give look like Linux attacked, <code>19890302_162952MPRAGEs0003a001.nii.gz</code>. The output from the <code>dcm2nii</code> program results in file names that are uniquely different across participants. For analyses though, we want all the files named exactly the same from participant to participant. In this case, we want all the files named <code>t1.nii</code>.</p>

<p>In addition to renaming the file, we want to use just the cropped and reorientated file (<code>co</code>). We want to delete the reorientation only (<code>o</code>) and original file (no <code>co</code> or <code>o</code> prefix).</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/t1
mv co*.nii t1.nii
rm o*.nii <span class="p">|</span> rm 2*.nii</code></pre></figure>

<h2 id="ac-pc-alignment">AC-PC Alignment</h2>

<p>Participants are more times than not, not perfectly positioned in the scanner. In fact, misalignment is a common clinical occurrence. Image quality is compromised when the brain is not aligned in the scanner and there’s a lack of standardization across participants and within participants if you are scanning over multiple sessions. Optimally, you want a way to standardize image acquisition and overall alignment. Because it is very difficult to perfectly position people, a short sequence will be run to get a midsagittal image. From there, the field of view box can be adjusted so that the anterior commissure and posterior commissure are on the same horizontal plane.</p>

<p>Here’s an image with the scanner FOV box (yellow). As you can see the box is adjusted so the AC and PC are on the same horizontal plane. You can also see in this image, how you can have a brain bigger than the FOV box (see issue above about cropping and reorientation). You cannot make the FOV box bigger, because that would change the number of slices in your scan sequence.</p>

<p><img class="img-responsive" alt="" src="images/acpc.jpg" /></p>

<p>Besides AC-PC alignment, you also don’t want the brain tilted left or right. The interhemispheric fissure (AKA medial longitudinal fissure) should be straight! And finally, the alignment of the origin is also critical. In the native brain, you want some standardization of where the location of (0, 0, 0) is on the x-, y-, and z-axis. Typically, the origin is located at the anterior commissure or half way between the anterior commissure and posterior commissure along the horizontal plane. There’s a program that can automatically fix all of these issues. However, the program only runs on Linux computers:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">acpcdetect <span class="se">\</span>
-M <span class="se">\</span>
-o <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/t1/acpc.nii <span class="se">\</span>
-i <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/t1/t1.nii</code></pre></figure>

<div class="row">
    <div class="col-xs-6">
		<img class="img-responsive" alt="" src="images/t1-cropped-reorientated.png" />
	</div>
	<div class="col-xs-6">
		<img class="img-responsive" alt="" src="images/t1-acpc.png" />
	</div>
</div>

<h2 id="correct-bias-field">Correct Bias Field</h2>

<p>Images often exhibit image intensity non-uniformities that are the result of magnetic field variations. These artifacts, often described as shading or bias, can be produced by imperfections in the field coils. These variations are often seen as a signal gain change. This can result in white matter measurements in one part of the image with the same intensity value as grey matter measurements elsewhere; an ideal T1-weighted image would display brighter white matter throughout the brain image.</p>

<p><img class="img-responsive" alt="" src="http://www.brainvoyager.com/bvqx/doc/UsersGuide/Segmentation/Images/IIHC_Explanation_sm.png" /></p>

<p>Image processing algorithms such as tissue segmentation use the pixel gray level values. If there is a bias field, the gray level values of the pixels will cause the algorithms to produce unsatisfactory results. A pre-processing step is needed to correct for the bias field signal before submitting corrupted MRI images to such algorithms. <strong><em>Note that at this point, we will output our file as <code>.nii.gz</code>. From this point on, we will use <code>.nii.gz</code> files. Only the <code>acpcdetect</code> program requires NIfTI only files.</em></strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">N4BiasFieldCorrection <span class="se">\</span>
-d <span class="m">3</span> <span class="se">\</span>
-i <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/t1/acpc.nii <span class="se">\</span>
-o <span class="o">[</span><span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/t1/n4.nii.gz,<span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/t1/biasfield.nii.gz<span class="o">]</span> <span class="se">\</span>
-s <span class="m">4</span> <span class="se">\ </span>
-b <span class="o">[</span>200<span class="o">]</span> <span class="se">\</span>
-c <span class="o">[</span>50x50x50x50,0.000001<span class="o">]</span></code></pre></figure>

<h2 id="resample-to-1-mm-isotropic">Resample to 1 mm Isotropic</h2>

<p>Sometimes you will need to resample your images. For instance, if the study involves MR images acquired at different locations and they are not all using the same sequence, (2) the study is longitudinal and there’s been a scanner or sequence upgrade between time points, or (3) the study involves DTI analyses, fMRI analyses, T2 weighted analyses, etc., then you will most likely have to resample your images.</p>

<p>If you want to register a DTI image to your T1 image, you will definitely have to resample your T1 image. Most likely your T1 image will have about 1mm voxels, but your diffusion weighted image will be 2mm voxels. Therefore, you will have to resample your T1 image to have 2mm voxels.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>c3d <span class="se">\</span>
&lt;inputImage&gt;.nii.gz <span class="se">\</span>
-resample-mm 1x1x1mm <span class="se">\</span>
-o &lt;outputImage&gt;.nii.gz</code></pre></figure>

<h4 id="reference-manuals">Reference Manuals</h4>

<ul>
  <li>dcm2nii - http://www.mccauslandcenter.sc.edu/mricro/mricron/dcm2nii.html</li>
  <li>Convert3D - http://www.itksnap.org/pmwiki/pmwiki.php?n=Convert3D.Documentation</li>
  <li>ANTs - https://github.com/stnava/ANTsDoc/raw/master/ants2.pdf</li>
  <li>acpcdetect - https://www.nitrc.org/docman/view.php/90/917/acpcdetect.pdf</li>
</ul>

<h4 id="further-readings">Further Readings</h4>

<ul>
  <li>Bias Correction - http://dx.doi.org/10.1109/TMI.2010.2046908</li>
  <li>Automatic Detection of AC/PC - http://dx.doi.org/10.1016/j.neuroimage.2009.02.030</li>
</ul>

<h3 id="additional-classroom-materials">Additional Classroom Materials</h3>

<ul>
  <li><a href="presentation">Lecture</a></li>
  <li><a href="assignment">Assignment</a></li>
</ul>

        </div>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




      <hr>
      <footer>
        <p>
          &copy; 2015 Naomi Goodrich-Hunsaker, Ph.D.
          <span class="pull-right text-muted">
            powered by
            <a href="http://dbtek.github.io/jekyll-bootstrap-3" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll-Bootstrap-3</a>
            and <a href="http://getbootstrap.com" target="_blank">Twitter Bootstrap 3.0.3</a>
          </span>
        </p>
      </footer>
    </div>

    

    <script src="/assets/themes/bootstrap/resources/jquery/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap/resources/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>

