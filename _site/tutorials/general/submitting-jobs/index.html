
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Submitting Batch Jobs on Supercomputer</title>
    
    <meta name="author" content="Naomi Goodrich-Hunsaker, Ph.D.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/assets/themes/bootstrap/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/themes/bootstrap/css/pygments.css">
  
    <!--[if lt IE 9]>
      <script src="/assets/themes/bootstrap/resources/respond/Respond.min.js"></script>
    <![endif]-->

    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Brain Imaging and Behavior Lab</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
          <li><a href="/tutorials">Tutorials </a></li>
          <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Projects <span class="caret"></span></a>
          <ul class="dropdown-menu">
          	<li class="dropdown-header">SOBIK</li>
            <li><a href="/projects/SOBIK/template/">Template</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">MIOS</li>
            <li><a href="/projects/MIOS/corpus-callosum">Corpus Callosum</a></li>
          </ul>
        </li>
        <li>  </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
    <div class="container">
      

<div class="page-header">
  <h1>Submitting Batch Jobs on Supercomputer </h1>
</div>

    <div class="row">
        <div class="col-sm-3">
            <div class="sidebar-nav">
                <div class="navbar navbar-default" role="navigation">
                    <div class="navbar-header">
                        <button class="navbar-toggle" data-target=".sidebar-navbar-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <span class="visible-xs navbar-brand">Sidebar menu</span>
                    </div>
                    <div class="navbar-collapse collapse sidebar-navbar-collapse">
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a class="dropdown-toggle" data-toggle="dropdown" href="#">General Topics <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                   <li><a href="/tutorials/general/unix-cheat-sheet/">Unix Cheat Sheet</a></li>
                                    <li><a href="/tutorials/general/introduction-to-fulton-supercomputer-lab/">Introduction to Fulton Supercomputer</a></li>
                                    <li><a href="/tutorials/general/submitting-jobs/">Submitting Batch Jobs on Supercomputer</a></li>
                                    <li><a href="/tutorials/general/R/">Learn R</a></li>
                                    <li><a href="/tutorials/general/install-freesurfer/">How to Install Freesurfer on Supercomputer</a></li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a class="dropdown-toggle" data-toggle="dropdown" href="#">Structural Imaging <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li><a href="/tutorials/structural/preprocessing_T1_weighted_images/">Preprocessing T1 Weighted Images</a></li>
                                    <li><a href="/tutorials/structural/convert-to-nifti/">Other Ways to Convert to NIfTI</a></li>
                                    <li><a href="/tutorials/structural/normalization/">Normalization</a></li>
                                    <li><a href="/tutorials/structural/cortical_thickness/">Tissue Segmentation and Cortical Thickness</a></li>
                                    <li><a href="/tutorials/structural/morphometry/">Various Morphometry Analyses</a></li>
                                    <li><a href="/tutorials/structural/ANTsR/">ANTsR</a></li>
                                    <li><a href="/tutorials/structural/group_average/">Group Average Overlays with ANTsR</a></li>
                                    <li><a href="/tutorials/structural/roi/">ROI Analysis with DKT</a></li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a class="dropdown-toggle" data-toggle="dropdown" href="#">Diffusion Imaging <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li><a href="/tutorials/diffusion/preprocessing_diffusion_weighted_images/">Preprocessing Diffusion Weighted Images</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div><!--/.nav-collapse -->
                </div>
            </div>
        </div>
        <div class="col-sm-9">
 <h2 id="objectives">Objectives</h2>

<p>After you complete this section, you should be able to:</p>

<ol>
  <li>Resources available via the supercomputer</li>
  <li>Understand batch job submission and required parameters</li>
  <li>SLURM commands</li>
  <li>Generate your own script for job submission</li>
  <li>Read output and standard error files generated from script</li>
  <li>Submit jobs for many participants</li>
</ol>

<p>Note that everything in “&lt;&gt;” is to be replaced. For example, &lt;fileName&gt; –&gt; iLovePeanuts.txt</p>

<h2 id="fsl-resources">FSL Resources</h2>

<ul>
  <li>The Fulton Supercomputing Lab offers a total of 16,928 CPU cores and about 50 TB of memory across 943 compute nodes.</li>
  <li>Compute resources are supported by approximately 2 petabytes of storage.</li>
  <li>All nodes have Red Hat Enterprise Linux 6.6.</li>
</ul>

<h2 id="job-submission">Job Submission</h2>

<p>The FSL is managed by a batch scheduling system. This means that in order to use the supercomputer, users must write a script that encapsulates the workload into a non-interactive job. This script is then submitted as a job to the scheduling system. There are certain parameters required for the scheduling system:</p>

<ul>
  <li>Either number of nodes and processors per node, or total number of processors</li>
  <li>Memory/RAM needed</li>
  <li>Expected running time (or “walltime”)</li>
</ul>

<p>Jobs are created by building a job script, usually written in bash or python, that specifies the necessary parameters described above, and then contains appropriate scripting to launch the program that will do the job’s work.</p>

<h2 id="scheduling-system">Scheduling System</h2>

<p>The scheduling system keeps track of the current state of all resources and jobs and decides, based on conditions and policies, where and when to start jobs. Jobs are started in priority order until no further jobs are eligible to start or it runs out of appropriate resources.</p>

<p>When the scheduling system chooses to start a job, it assigns it one or more nodes/processors, as requested by the job, and launches the provided job script on the first node in the list of those assigned. The responsibility of taking advantage of all the requested resources is left up to the job script.</p>

<h2 id="slurm-commands">SLURM Commands</h2>

<ul>
  <li><code>sbatch</code> is used to submit jobs</li>
  <li><code>squeue -u &lt;username&gt;</code> is used to show your queue</li>
  <li><code>scancel &lt;jobid&gt;</code> cancels a specific job</li>
  <li><code>scancel -u &lt;username&gt;</code> cancels all jobs for that user</li>
  <li><code>sacct</code> shows current and historical job information</li>
</ul>

<h2 id="example-job-script">Example Job Script</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="c">#SBATCH --time=50:00:00   # walltime</span>
<span class="c">#SBATCH --ntasks=1  # number of processor cores (i.e. tasks)</span>
<span class="c">#SBATCH --nodes=1   # number of nodes</span>
<span class="c">#SBATCH --mem-per-cpu=8192M   # memory per CPUS core</span>
<span class="c">#SBATCH -o /fslhome/&lt;username&gt;/logfiles/20151029/output0.txt</span>
<span class="c">#SBATCH -e /fslhome/&lt;username&gt;/examples/20151029/error0.txt</span>
<span class="c">#SBATCH -J &quot;antsCorticalThickness0&quot;   # job name</span>

<span class="c"># Compatibility variables for PBS. Delete if not needed.</span>
<span class="nb">export </span><span class="nv">PBS_NODEFILE</span><span class="o">=</span><span class="sb">`</span>/fslapps/fslutils/generate_pbs_nodefile<span class="sb">`</span>
<span class="nb">export </span><span class="nv">PBS_JOBID</span><span class="o">=</span><span class="nv">$SLURM_JOB_ID</span>
<span class="nb">export </span><span class="nv">PBS_O_WORKDIR</span><span class="o">=</span><span class="s2">&quot;$SLURM_SUBMIT_DIR&quot;</span>
<span class="nb">export </span><span class="nv">PBS_QUEUE</span><span class="o">=</span>batch

<span class="c"># Set the max number of threads to use for programs using OpenMP.</span>
<span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$SLURM_CPUS_ON_NODE</span>

<span class="c"># LOAD MODULES, SET ENVIRONMENTAL VARIABLES HERE</span>
<span class="nb">export </span><span class="nv">ANTSPATH</span><span class="o">=</span>/fslhome/&lt;username&gt;/apps/ants/bin/
<span class="nv">PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">ANTSPATH</span><span class="k">}</span>:<span class="k">${</span><span class="nv">PATH</span><span class="k">}</span>

<span class="c"># INSERT CODE, AND RUN YOUR PROGRAMS HERE</span>
<span class="nv">subjDir</span><span class="o">=</span>/fslhome/&lt;username&gt;/compute/data/1304_082907
<span class="nv">templateDir</span><span class="o">=</span>/fslhome/&lt;username&gt;/templates/OASIS

antsCorticalThickness.sh <span class="se">\</span>
-d <span class="m">3</span> <span class="se">\</span>
-a <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/n4.nii.gz <span class="se">\ </span>
-e <span class="k">${</span><span class="nv">templateDir</span><span class="k">}</span>/T_template0.nii.gz <span class="se">\</span>
-t <span class="k">${</span><span class="nv">templateDir</span><span class="k">}</span>/T_template0_BrainCerebellum.nii.gz <span class="se">\</span>
-m <span class="k">${</span><span class="nv">templateDir</span><span class="k">}</span>/T_template0_BrainCerebellumProbabilityMask.nii.gz <span class="se">\ </span>
-f <span class="k">${</span><span class="nv">templateDir</span><span class="k">}</span>/T_template0_BrainCerebellumExtractionMask.nii.gz <span class="se">\ </span>
-p <span class="k">${</span><span class="nv">templateDir</span><span class="k">}</span>/Priors2/priors%d.nii.gz <span class="se">\</span>
-q <span class="m">1</span> <span class="se">\</span>
-o <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/antsCorticalThickness/</code></pre></figure>

<h2 id="read-output--error-files">Read Output / Error files</h2>

<p>When you run batch commands, the output is sent to a text file instead of appearing on your screen. As with everything else, organization is needed in order to manage these output files. Especially if you are running a study with hundreds of participants. You’ll have hundreds of output and error files!</p>

<h3 id="vi-versus-cat"><em>vi</em> versus <em>cat</em></h3>

<p><em>Cat</em> is the main command to read and print out the standard output and error files. When you <em>just</em> want to display the contents of a file, use <code>cat</code>. <em>Cat</em> is the most convenient program from displaying the contents of a text file.</p>

<p>On the other hand, if you want to edit a text file, use <em>vi</em> or <em>nano</em>, which are specifically text editors.</p>

<p>To check the output from your process, type:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">cat &lt;output&gt;.txt</code></pre></figure>

<p>If your script ends early, type:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">cat &lt;error&gt;.txt</code></pre></figure>

<h2 id="submitting-a-job-for-many-participants">Submitting a Job for Many Participants</h2>

<p>In order to submit a job for many participants, you could either generate a job script for each participant. However, if you have hundreds or thousands of participants, it does not make sense to generate that many job script files. Another alternative is to use a for loop:</p>

<h3 id="batchscriptsh">BatchScript.sh</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="k">for</span> subj in <span class="k">$(</span>ls ~/path/to/subject/directories/<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
sbatch <span class="se">\</span>
-o ~/path/to/logfiles/output_<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>.txt <span class="se">\</span>
-e ~/path/to/logfiles/error_<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>.txt <span class="se">\</span>
~/path/to/jobScript.sh <span class="se">\</span>
<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>
sleep 1
<span class="k">done</span></code></pre></figure>

<p>This <em>for</em> loop, loops through all your directories setting the output and error text file with the subject directory name and submitting the jobScript.sh file with the input variable ${subj}. By using ${1} in your job script, you’ll be able to loop through all your participants.</p>

<h3 id="jobscriptsh">JobScript.sh</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="c">#SBATCH --time=50:00:00   # walltime</span>
<span class="c">#SBATCH --ntasks=1   # number of processor cores (i.e. tasks)</span>
<span class="c">#SBATCH --nodes=1   # number of nodes</span>
<span class="c">#SBATCH --mem-per-cpu=16384M  # memory per CPU core</span>

<span class="c"># Compatibility variables for PBS. Delete if not needed.</span>
<span class="nb">export </span><span class="nv">PBS_NODEFILE</span><span class="o">=</span><span class="sb">`</span>/fslapps/fslutils/generate_pbs_nodefile<span class="sb">`</span>
<span class="nb">export </span><span class="nv">PBS_JOBID</span><span class="o">=</span><span class="nv">$SLURM_JOB_ID</span>
<span class="nb">export </span><span class="nv">PBS_O_WORKDIR</span><span class="o">=</span><span class="s2">&quot;$SLURM_SUBMIT_DIR&quot;</span>
<span class="nb">export </span><span class="nv">PBS_QUEUE</span><span class="o">=</span>batch

<span class="c"># Set the max number of threads to use for programs using OpenMP.</span>
<span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$SLURM_CPUS_ON_NODE</span>

<span class="c"># LOAD MODULES AND SET ENVIRONMENTAL VARIABLES</span>
<span class="nb">export </span><span class="nv">ANTSPATH</span><span class="o">=</span>~/apps/ants/bin/
<span class="nv">PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">ANTSPATH</span><span class="k">}</span>:<span class="k">${</span><span class="nv">PATH</span><span class="k">}</span>

<span class="c"># INSERT CODE, AND RUN YOUR PROGRAMS HERE</span>
<span class="nv">SUBJ_DIR</span><span class="o">=</span>~/path/to/subject/directories/<span class="k">${</span><span class="nv">1</span><span class="k">}</span>
<span class="nv">TEMPLATE_DIR</span><span class="o">=</span>~/templates/NKI10andUnder
<span class="nv">OUT_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SUBJ_DIR</span><span class="k">}</span>/antsCorticalThickness
~/apps/ants/bin/antsCorticalThickness.sh -d <span class="m">3</span> <span class="se">\</span>
-a <span class="k">${</span><span class="nv">SUBJ_DIR</span><span class="k">}</span>/t1/resampled1iso.nii.gz <span class="se">\</span>
-e <span class="k">${</span><span class="nv">TEMPLATE_DIR</span><span class="k">}</span>/T_template0.nii.gz <span class="se">\</span>
-t <span class="k">${</span><span class="nv">TEMPLATE_DIR</span><span class="k">}</span>/T_template0_BrainCerebellum.nii.gz <span class="se">\</span>
-m <span class="k">${</span><span class="nv">TEMPLATE_DIR</span><span class="k">}</span>/T_template0_BrainCerebellumProbabilityMask.nii.gz <span class="se">\</span>
-f <span class="k">${</span><span class="nv">TEMPLATE_DIR</span><span class="k">}</span>/T_template0_BrainCerebellumExtractionMask.nii.gz <span class="se">\</span>
-p <span class="k">${</span><span class="nv">TEMPLATE_DIR</span><span class="k">}</span>/Priors2/priors%d.nii.gz <span class="se">\</span>
-q <span class="m">1</span> <span class="se">\</span>
-o <span class="k">${</span><span class="nv">OUT_DIR</span><span class="k">}</span>/</code></pre></figure>

<p>Then when you want to submit job scripts for all your participants, you simply have to submit your BatchScript.sh script:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">sh ~/path/to/BatchScript.sh</code></pre></figure>

<h3 id="additional-classroom-materials">Additional Classroom Materials</h3>

<ul>
  <li><a href="presentation">Lecture</a></li>
  <li><a href="assignment-part1">Assignment Part 1</a></li>
  <li><a href="assignment-part2">Assignment Part 2</a></li>
</ul>

        </div>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




      <hr>
      <footer>
        <p>
          &copy; 2015 Naomi Goodrich-Hunsaker, Ph.D.
          <span class="pull-right text-muted">
            powered by
            <a href="http://dbtek.github.io/jekyll-bootstrap-3" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll-Bootstrap-3</a>
            and <a href="http://getbootstrap.com" target="_blank">Twitter Bootstrap 3.0.3</a>
          </span>
        </p>
      </footer>
    </div>

    

    <script src="/assets/themes/bootstrap/resources/jquery/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap/resources/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>

