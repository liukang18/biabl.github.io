<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submitting Batch Jobs on Supercomputer &mdash; Brain Imaging and Behavior Lab</title>
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/logo.png"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Brain Imaging and Behavior Lab" />
    <meta name="title" content="Submitting Batch Jobs on Supercomputer ">
    <link rel="canonical" href="http://biabl.github.io/tutorials/general/submitting_jobs/">
     
           
    <meta property="og:title" content="Submitting Batch Jobs on Supercomputer "/>
    <meta property="og:url" content="http://biabl.github.io/tutorials/general/submitting_jobs/"/>
    
    
    <meta property="og:site_name" content="Brain Imaging and Behavior Lab">     
</head>
<body>
    <section class="site-nav">
        <header>
            <nav id="navigation">
                <a class="brand" href="/"><img alt="Inc" src="/images/logo.png"></a> 
                <a class="home" href="/">Blog</a>
                <a class="home" href="/tags/">Tags</a>
				<li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
                    <ul class="dropdown-menu multi-level">
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">General Topics</a>
                            <ul class="dropdown-menu">
                                <li><a href="/tutorials/general/unix-cheat-sheet/">Unix Cheat Sheet</a></li>
                				<li><a href="/tutorials/general/introduction-to-fulton-supercomputer-lab/">Introduction to Fulton Supercomputer</a></li>
                				<li><a href="/tutorials/general/submitting_jobs/">Submitting Batch Jobs on Supercomputer</a></li>
                				<li><a href="/tutorials/general/R/">Learn R</a></li>
                				<li><a href="/tutorials/general/install-freesurfer/">How to Install Freesurfer on Supercomputer</a></li>
                            </ul>
                        </li>
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Structural Imaging Topics</a>
                            <ul class="dropdown-menu">
                                <li><a href="/tutorials/structural/preprocessing_T1_weighted_images/">Preprocessing T1 Weighted Images</a></li>
                				<li><a href="/tutorials/structural/convert-to-nifti/">Other Ways to Convert to NIfTI</a></li>
                				<li><a href="/tutorials/structural/normalization/">Normalization</a></li>
                				<li><a href="/tutorials/structural/cortical_thickness/">Tissue Segmentation and Cortical Thickness</a></li>
                				<li><a href="/tutorials/structural/morphometry/">Various Morphometry Analyses</a></li>
                				<li><a href="/tutorials/structural/ANTsR/">ANTsR</a></li>
                				<li><a href="/tutorials/structural/group_average/">Group Average Overlays with ANTsR</a></li>
                				<li><a href="/tutorials/structural/roi/">ROI Analysis with DKT</a></li>
                            </ul>
                        </li>
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Diffusion Imaging Topics</a>
                            <ul class="dropdown-menu">
                                <li><a href="/tutorials/diffusion/preprocessing_diffusion_weighted_images/">Preprocessing Diffusion Weighted Images</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Projects<b class="caret"></b></a>
                    <ul class="dropdown-menu multi-level">
                        <li class="dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">MIOS</a>
                            <ul class="dropdown-menu">
                                <li><a href="/projects/MIOS/corpus-callosum/">Corpus Callosum</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </nav>
        </header>
    </section>
    
<article>

    <div class="container">
        <header>
        	
            <div class="meta">
                By <address><a rel="author" href="" title="Naomi J. Goodrich-Hunsaker" target="_blank">Naomi J. Goodrich-Hunsaker</a></address> &mdash;
                <time pubdate datetime="2015-09-December" title="December 09, 2015">December 09, 2015</time>
            </div>
            <h1 class="title">Submitting Batch Jobs on Supercomputer</h1>
            
        </header>

        <section>
            <h2 id="objectives">Objectives</h2>

<p>After you complete this section, you should be able to:</p>

<ol>
  <li>Resources available via the supercomputer</li>
  <li>Understand batch job submission and required parameters</li>
  <li>SLURM commands</li>
  <li>Generate your own script for job submission</li>
  <li>Read output and standard error files generated from script</li>
  <li>Submit jobs for many participants</li>
</ol>

<p>Note that everything in “&lt;&gt;” is to be replaced. For example, &lt;fileName&gt; –&gt; iLovePeanuts.txt</p>

<h2 id="fsl-resources">FSL Resources</h2>

<ul>
  <li>The Fulton Supercomputing Lab offers a total of 16,928 CPU cores and about 50 TB of memory across 943 compute nodes.</li>
  <li>Compute resources are supported by approximately 2 petabytes of storage.</li>
  <li>All nodes have Red Hat Enterprise Linux 6.6.</li>
</ul>

<h2 id="job-submission">Job Submission</h2>

<p>The FSL is managed by a batch scheduling system. This means that in order to use the supercomputer, users must write a script that encapsulates the workload into a non-interactive job. This script is then submitted as a job to the scheduling system. There are certain parameters required for the scheduling system:</p>

<ul>
  <li>Either number of nodes and processors per node, or total number of processors</li>
  <li>Memory/RAM needed</li>
  <li>Expected running time (or “walltime”)</li>
</ul>

<p>Jobs are created by building a job script, usually written in bash or python, that specifies the necessary parameters described above, and then contains appropriate scripting to launch the program that will do the job’s work.</p>

<h2 id="scheduling-system">Scheduling System</h2>

<p>The scheduling system keeps track of the current state of all resources and jobs and decides, based on conditions and policies, where and when to start jobs. Jobs are started in priority order until no further jobs are eligible to start or it runs out of appropriate resources.</p>

<p>When the scheduling system chooses to start a job, it assigns it one or more nodes/processors, as requested by the job, and launches the provided job script on the first node in the list of those assigned. The responsibility of taking advantage of all the requested resources is left up to the job script.</p>

<h2 id="slurm-commands">SLURM Commands</h2>

<ul>
  <li><code>sbatch</code> is used to submit jobs</li>
  <li><code>squeue -u &lt;username&gt;</code> is used to show your queue</li>
  <li><code>scancel &lt;jobid&gt;</code> cancels a specific job</li>
  <li><code>scancel -u &lt;username&gt;</code> cancels all jobs for that user</li>
  <li><code>sacct</code> shows current and historical job information</li>
</ul>

<h2 id="example-job-script">Example Job Script</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="c">#SBATCH --time=50:00:00   # walltime</span>
<span class="c">#SBATCH --ntasks=1  # number of processor cores (i.e. tasks)</span>
<span class="c">#SBATCH --nodes=1   # number of nodes</span>
<span class="c">#SBATCH --mem-per-cpu=8192M   # memory per CPUS core</span>
<span class="c">#SBATCH -o /fslhome/&lt;username&gt;/logfiles/20151029/output0.txt</span>
<span class="c">#SBATCH -e /fslhome/&lt;username&gt;/examples/20151029/error0.txt</span>
<span class="c">#SBATCH -J &quot;antsCorticalThickness0&quot;   # job name</span>

<span class="c"># Compatibility variables for PBS. Delete if not needed.</span>
<span class="nb">export </span><span class="nv">PBS_NODEFILE</span><span class="o">=</span><span class="sb">`</span>/fslapps/fslutils/generate_pbs_nodefile<span class="sb">`</span>
<span class="nb">export </span><span class="nv">PBS_JOBID</span><span class="o">=</span><span class="nv">$SLURM_JOB_ID</span>
<span class="nb">export </span><span class="nv">PBS_O_WORKDIR</span><span class="o">=</span><span class="s2">&quot;$SLURM_SUBMIT_DIR&quot;</span>
<span class="nb">export </span><span class="nv">PBS_QUEUE</span><span class="o">=</span>batch

<span class="c"># Set the max number of threads to use for programs using OpenMP.</span>
<span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$SLURM_CPUS_ON_NODE</span>

<span class="c"># LOAD MODULES, SET ENVIRONMENTAL VARIABLES HERE</span>
<span class="nb">export </span><span class="nv">ANTSPATH</span><span class="o">=</span>/fslhome/&lt;username&gt;/apps/ants/bin/
<span class="nv">PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">ANTSPATH</span><span class="k">}</span>:<span class="k">${</span><span class="nv">PATH</span><span class="k">}</span>

<span class="c"># INSERT CODE, AND RUN YOUR PROGRAMS HERE</span>
<span class="nv">subjDir</span><span class="o">=</span>/fslhome/&lt;username&gt;/compute/data/1304_082907
<span class="nv">templateDir</span><span class="o">=</span>/fslhome/&lt;username&gt;/templates/OASIS

antsCorticalThickness.sh <span class="se">\</span>
-d <span class="m">3</span> <span class="se">\</span>
-a <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/n4.nii.gz <span class="se">\ </span>
-e <span class="k">${</span><span class="nv">templateDir</span><span class="k">}</span>/T_template0.nii.gz <span class="se">\</span>
-t <span class="k">${</span><span class="nv">templateDir</span><span class="k">}</span>/T_template0_BrainCerebellum.nii.gz <span class="se">\</span>
-m <span class="k">${</span><span class="nv">templateDir</span><span class="k">}</span>/T_template0_BrainCerebellumProbabilityMask.nii.gz <span class="se">\ </span>
-f <span class="k">${</span><span class="nv">templateDir</span><span class="k">}</span>/T_template0_BrainCerebellumExtractionMask.nii.gz <span class="se">\ </span>
-p <span class="k">${</span><span class="nv">templateDir</span><span class="k">}</span>/Priors2/priors%d.nii.gz <span class="se">\</span>
-q <span class="m">1</span> <span class="se">\</span>
-o <span class="k">${</span><span class="nv">subjDir</span><span class="k">}</span>/antsCorticalThickness/</code></pre></div>

<h2 id="read-output--error-files">Read Output / Error files</h2>

<p>When you run batch commands, the output is sent to a text file instead of appearing on your screen. As with everything else, organization is needed in order to manage these output files. Especially if you are running a study with hundreds of participants. You’ll have hundreds of output and error files!</p>

<h3 id="vi-versus-cat"><em>vi</em> versus <em>cat</em></h3>

<p><em>Cat</em> is the main command to read and print out the standard output and error files. When you <em>just</em> want to display the contents of a file, use <code>cat</code>. <em>Cat</em> is the most convenient program from displaying the contents of a text file.</p>

<p>On the other hand, if you want to edit a text file, use <em>vi</em> or <em>nano</em>, which are specifically text editors.</p>

<p>To check the output from your process, type:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">cat &lt;output&gt;.txt</code></pre></div>

<p>If your script ends early, type:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">cat &lt;error&gt;.txt</code></pre></div>

<h2 id="submitting-a-job-for-many-participants">Submitting a Job for Many Participants</h2>

<p>In order to submit a job for many participants, you could either generate a job script for each participant. However, if you have hundreds or thousands of participants, it does not make sense to generate that many job script files. Another alternative is to use a for loop:</p>

<h3 id="batchscriptsh">BatchScript.sh</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="k">for</span> subj in <span class="k">$(</span>ls ~/path/to/subject/directories/<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
sbatch <span class="se">\</span>
-o ~/path/to/logfiles/output_<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>.txt <span class="se">\</span>
-e ~/path/to/logfiles/error_<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>.txt <span class="se">\</span>
~/path/to/jobScript.sh <span class="se">\</span>
<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>
sleep 1
<span class="k">done</span></code></pre></div>

<p>This <em>for</em> loop, loops through all your directories setting the output and error text file with the subject directory name and submitting the jobScript.sh file with the input variable ${subj}. By using ${1} in your job script, you’ll be able to loop through all your participants.</p>

<h3 id="jobscriptsh">JobScript.sh</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="c">#SBATCH --time=50:00:00   # walltime</span>
<span class="c">#SBATCH --ntasks=1   # number of processor cores (i.e. tasks)</span>
<span class="c">#SBATCH --nodes=1   # number of nodes</span>
<span class="c">#SBATCH --mem-per-cpu=16384M  # memory per CPU core</span>

<span class="c"># Compatibility variables for PBS. Delete if not needed.</span>
<span class="nb">export </span><span class="nv">PBS_NODEFILE</span><span class="o">=</span><span class="sb">`</span>/fslapps/fslutils/generate_pbs_nodefile<span class="sb">`</span>
<span class="nb">export </span><span class="nv">PBS_JOBID</span><span class="o">=</span><span class="nv">$SLURM_JOB_ID</span>
<span class="nb">export </span><span class="nv">PBS_O_WORKDIR</span><span class="o">=</span><span class="s2">&quot;$SLURM_SUBMIT_DIR&quot;</span>
<span class="nb">export </span><span class="nv">PBS_QUEUE</span><span class="o">=</span>batch

<span class="c"># Set the max number of threads to use for programs using OpenMP.</span>
<span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$SLURM_CPUS_ON_NODE</span>

<span class="c"># LOAD MODULES AND SET ENVIRONMENTAL VARIABLES</span>
<span class="nb">export </span><span class="nv">ANTSPATH</span><span class="o">=</span>~/apps/ants/bin/
<span class="nv">PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">ANTSPATH</span><span class="k">}</span>:<span class="k">${</span><span class="nv">PATH</span><span class="k">}</span>

<span class="c"># INSERT CODE, AND RUN YOUR PROGRAMS HERE</span>
<span class="nv">SUBJ_DIR</span><span class="o">=</span>~/path/to/subject/directories/<span class="k">${</span><span class="nv">1</span><span class="k">}</span>
<span class="nv">TEMPLATE_DIR</span><span class="o">=</span>~/templates/NKI10andUnder
<span class="nv">OUT_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SUBJ_DIR</span><span class="k">}</span>/antsCorticalThickness
~/apps/ants/bin/antsCorticalThickness.sh -d <span class="m">3</span> <span class="se">\</span>
-a <span class="k">${</span><span class="nv">SUBJ_DIR</span><span class="k">}</span>/t1/resampled1iso.nii.gz <span class="se">\</span>
-e <span class="k">${</span><span class="nv">TEMPLATE_DIR</span><span class="k">}</span>/T_template0.nii.gz <span class="se">\</span>
-t <span class="k">${</span><span class="nv">TEMPLATE_DIR</span><span class="k">}</span>/T_template0_BrainCerebellum.nii.gz <span class="se">\</span>
-m <span class="k">${</span><span class="nv">TEMPLATE_DIR</span><span class="k">}</span>/T_template0_BrainCerebellumProbabilityMask.nii.gz <span class="se">\</span>
-f <span class="k">${</span><span class="nv">TEMPLATE_DIR</span><span class="k">}</span>/T_template0_BrainCerebellumExtractionMask.nii.gz <span class="se">\</span>
-p <span class="k">${</span><span class="nv">TEMPLATE_DIR</span><span class="k">}</span>/Priors2/priors%d.nii.gz <span class="se">\</span>
-q <span class="m">1</span> <span class="se">\</span>
-o <span class="k">${</span><span class="nv">OUT_DIR</span><span class="k">}</span>/</code></pre></div>

<p>Then when you want to submit job scripts for all your participants, you simply have to submit your BatchScript.sh script:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sh ~/path/to/BatchScript.sh</code></pre></div>

<h3 id="additional-classroom-materials">Additional Classroom Materials</h3>

<ul>
  <li><a href="presentation">Lecture</a></li>
  <li><a href="assignment-part1">Assignment Part 1</a></li>
  <li><a href="assignment-part2">Assignment Part 2</a></li>
</ul>

            
        </section>

        <footer>
            <address>
               <img src="/images/naomi.jpg">
                <p>Written by <strong><a rel="author" href="https://twitter.com/" title="" target="_blank">Naomi J. Goodrich-Hunsaker</a></strong><br>
                <span class="muted">Website Manager</span>
                </p>
            </address>

        </footer>

        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'biabl'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>

    <footer class="site-footer">
        <div class="container">
            &copy; 2015
            <nav>
                <a href="http://biabl.github.io">Brain Imaging and Behavior Lab</a>
            </nav>
            <nav class="social">
                 
                 
                <a href="/feed.xml" title="RSS Feed"><i class="icon icon-rss black"></i></a>
            </nav>
        </div>
    </footer>
    
      <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js" defer></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" defer></script>
  <script src="dist/js/bootstrap-submenu.min.js" defer></script>
  <style type="text/css">
<script src="/assets/main.js"></script>







</body>
</html>